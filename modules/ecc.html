<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Elliptic Curve Point Addition and Point Doubling</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <h1>ECC Point Addition and Doubling Calculator</h1>

  y<sup>2</sup> = x<sup>3</sup> + 
  <input type="number" id="a" placeholder="a" oninput="calculateECC()"> 
  â€¢ x + 
  <input type="number" id="b" placeholder="b" oninput="calculateECC()"> 
  mod 
  <input type="number" id="p" placeholder="p" oninput="calculateECC()">

  <br><br>

  P = (
  <input type="number" id="x1" placeholder="x1" oninput="calculateECC()">
  , 
  <input type="number" id="y1" placeholder="y1" oninput="calculateECC()">
  )

  <br>

  Q = (
  <input type="number" id="x2" placeholder="x2" oninput="calculateECC()">
  , 
  <input type="number" id="y2" placeholder="y2" oninput="calculateECC()">
  )

  <br><br>

  <p><span id="calculation"></span></p>

  <script>
    let latexMode = false;

    window.onload = function() {
      calculateECC();
    }

    function positiveMod(a, n) {      
      return ((a % n) + n) % n;
    }

    function modInverse(a, m) {
      a = positiveMod(a, m);
    
      let [old_r, r] = [a, m];
      let [old_s, s] = [1, 0];
      let [old_t, t] = [0, 1];

      while (r !== 0) {
        const quotient = Math.floor(old_r / r);
        [old_r, r] = [r, old_r - quotient * r];
        [old_s, s] = [s, old_s - quotient * s];
        [old_t, t] = [t, old_t - quotient * t];
      }

      if (old_r !== 1) {
          throw new Error('Modular inverse does not exist');
      }
    
      return positiveMod(old_s, m);
    }

    function calculateECC() {
      const a = parseInt(document.getElementById("a").value);
      const b = parseInt(document.getElementById("b").value);
      const p = parseInt(document.getElementById("p").value);

      if (isNaN(a) || isNaN(b) || isNaN(p)) {
        return;
      } else if ((4 * a**3 + 27 * b**2) % p == 0) {
        document.getElementById("calculation").innerHTML = "Is <b>not</b> a valid elliptic curve!";
        return;
      }

      const x1 = parseInt(document.getElementById("x1").value);
      const y1 = parseInt(document.getElementById("y1").value);
      const x2 = parseInt(document.getElementById("x2").value);
      const y2 = parseInt(document.getElementById("y2").value);

      if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) {
        document.getElementById("calculation").innerHTML = "Is a valid elliptic curve!";
        return;
      } else if ((y1**2 % p != (x1**3 + a * x1 + b) % p) || (y2**2 % p != (x2**3 + a * x2 + b) % p)) {
        document.getElementById("calculation").innerHTML = "One of the points is not on the curve!";
        return;
      }

      let s = 0;
      if (positiveMod(x1, p) == positiveMod(x2, p) & positiveMod(y1, p) == positiveMod(-y2, p)) {
        document.getElementById("calculation").innerHTML = `P + Q = (0, 0)`;
        return;
      }
      else if (positiveMod(x1, p) == positiveMod(x2, p) & positiveMod(y1, p) == positiveMod(y2, p)) {
        s = ((3 * x1**2 + a) * modInverse(2*y1, p)) % p;
      } else {
        s = ((y2 - y1) * modInverse(x2-x1, p)) % p;
      }

      const x3 = positiveMod(s**2 - x1 - x2, p);
      const y3 = positiveMod(s * (x1 - x3) - y1, p);

      document.getElementById("calculation").innerHTML = `P + Q = (${x3}, ${y3})`;
    }
  </script>
</body>
</html>