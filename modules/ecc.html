<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Elliptic Curve Point Addition and Point Doubling</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <h1>ECC Point Addition and Doubling Calculator</h1>

  y<sup>2</sup> = x<sup>3</sup> + 
  <input type="number" id="a" placeholder="a" oninput="calculateECC()"> 
  • x + 
  <input type="number" id="b" placeholder="b" oninput="calculateECC()"> 
  mod 
  <input type="number" id="p" placeholder="p" oninput="calculateECC()">
  <span id="curve_valid"></span>

  <br><br>

  P = (
  <input type="number" id="x1" placeholder="x1" oninput="calculateECC()">
  , 
  <input type="number" id="y1" placeholder="y1" oninput="calculateECC()">
  )
  <span id="p_valid"></span>

  <br>

  Q = (
  <input type="number" id="x2" placeholder="x2" oninput="calculateECC()">
  , 
  <input type="number" id="y2" placeholder="y2" oninput="calculateECC()">
  )
  <span id="q_valid"></span>

  <br><br>

  <p><span id="calculation"></span></p>

  <script>
    window.onload = function() {
      calculateECC();
    }

    function clearElements(arr) {
      for (const id of arr) {
        document.getElementById(id).innerHTML = "";
      }
    }

    function getValue(id) {
      return parseInt(document.getElementById(id).value);
    }

    function setHTML(id, content) {
      return document.getElementById(id).innerHTML = content;
    }

    function setColor(id, color) {
      return document.getElementById(id).style.color = color;
    }

    function calculateECC() {
      const a = getValue("a");
      const b = getValue("b");
      const p = getValue("p");

      function mod(n) {
        return ((n % p) + p) % p;
      }

      function inverse(n) {
        n = mod(n);
        let [r, r1] = [n, p];
        let [s, s1] = [1, 0];

        while (r1 !== 0) {
          const quotient = Math.floor(r / r1);
          [r, r1] = [r1, r - quotient * r1];
          [s, s1] = [s1, s - quotient * s1];
        }

        if (r !== 1) throw new Error("Modular inverse does not exist");
        return mod(s);
      }

      if (isNaN(a) || isNaN(b) || isNaN(p)) {
        clearElements(["curve_valid", "p_valid", "q_valid", "calculation"]);
        return;
      } else if (mod(4 * a**3 + 27 * b**2) == 0 || p <= 3) {
        clearElements(["p_valid", "q_valid", "calculation"]);
        setHTML("curve_valid", "(invalid curve)");
        setColor("curve_valid", "red");
        return;
      } else {
        setHTML("curve_valid", "(valid curve)");
        setColor("curve_valid", "green");
      }

      const x1 = getValue("x1");
      const y1 = getValue("y1");
      const x2 = getValue("x2");
      const y2 = getValue("y2");

      let pInvalid = true;
      let qInvalid = true;

      if (isNaN(x1) || isNaN(y1)) {
        clearElements(["p_valid"]);
      } else if (mod(y1**2) == mod(x1**3 + a * x1 + b)) {
        setHTML("p_valid", "(point on curve)");
        setColor("p_valid", "green");
        pInvalid = false;
      } else {
        setHTML("p_valid", "(point not on curve)");
        setColor("p_valid", "red");
      }

      if (isNaN(x2) || isNaN(y2)) {
        clearElements(["q_valid"]);
      } else if (mod(y2**2) == mod(x2**3 + a * x2 + b)) {
        setHTML("q_valid", "(point on curve)");
        setColor("q_valid", "green");
        qInvalid = false;
      } else {
        setHTML("q_valid", "(point not on curve)");
        setColor("q_valid", "red");
      }

      if (pInvalid || qInvalid) {
        clearElements(["calculation"]);
        return;
      }

      let s = 0;
      let calculation = "";
      if (mod(x1) == mod(x2) & mod(y1) == mod(-y2)) {
        calculation = `(${x1}, ${y1}) = (${x2}, -${y2}) <br><br>`;
        calculation += "P + Q = (0, 0)";
        setHTML("calculation", calculation);
        return;
      } else if (mod(x1) == mod(x2) & mod(y1) == mod(y2)) {
        calculation = `(${x1}, ${y1}) = (${x2}, ${y2}) <br><br>`;
        s = mod((3 * x1**2 + a) * inverse(2*y1));
        calculation += `s = (3 • ${x1}<sup>2</sup> + ${a}) • (2 • ${y1})<sup>-1</sup> = ${s} mod ${p} <br><br>`;
      } else {
        calculation = `(${x1}, ${y1}) ≠ (${x2}, ${y2}) <br><br>`;
        s = mod((y2 - y1) * inverse(x2-x1, p));
        calculation += `s = (${y2} - ${y1}) • (${x2} - ${x1})<sup>-1</sup> = ${s} mod ${p} <br><br>`;
      }

      const x3 = mod(s**2 - x1 - x2);
      calculation += `x<sub>3</sub> = ${s}<sup>2</sup> - ${x1} - ${x2} = ${x3} mod ${p} <br>`;
      const y3 = mod(s * (x1 - x3) - y1);
      calculation += `y<sub>3</sub> = ${s} • (${x1} - ${x3}) - ${y1} = ${y3} mod ${p} <br><br>`;
      
      calculation += `P + Q = (${x3}, ${y3})`;

      setHTML("calculation", calculation);
    }
  </script>
</body>
</html>